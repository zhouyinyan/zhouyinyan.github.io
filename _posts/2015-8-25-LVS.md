---
layout: post
title: LVS
---

一、可伸缩网络服务的设计与实现

可伸缩网络服务的定义：可伸缩网络服务是指网络服务能随着用户的增长而扩展其性能，如在系统中增加服务器，内存或硬盘等；整个系统很容易被扩展，无须重置整个系统，中断服务。

可伸缩系统通常是高可用系统，在部分硬件或者部分软件失效的情况下，可以继续提供服务，终端用户不会感知到整个服务中断。

实现可伸缩网络服务的方法一般通过一对多的映射机制将请求分流到多个节点上处理。一对多可以多个层次上存在，如主机名上的DNS系统，网络层的TCP/IP,文件系统等。虚拟(Virtual)是描述一对多映射机制的词语，将多个实体组成一个逻辑上的，虚拟的整体。

SAMC:
Scalability（可伸缩性），当服务增长时，系统能被扩展来满足需求，且不降低服务质量
Availability（高可用性），尽管部分硬件或者软件出现故障，整个服务是可用的。
Managability(可管理性），整个系统容易管理
Cost-effectiveness（价格有效性），整个系统的实现是经济的。

LVS集群的结构
LVS集群采用基于IP和内容的请求分发技术，调度器具有很好的吞吐率，将请求分发到不同的服务器上，且调度器具有自动屏蔽掉服务器的故障，从而将一组服务器构成一个高性能，高可用的虚拟服务器。

![](https://raw.githubusercontent.com/zhouyinyan/zhouyinyan.github.io/master/images/LVS/LVS-1.jpg)

- 负载调度器(load balancer),它是真个集群对外的前端机，负责将客户请求发送到一组服务器上执行，而客户认为服务是来自一个ip地址的。它可以是用ip负载均衡技术或者基于内容请求分发，还可以是两者的结合。
- 服务器池（server pool),一组真正执行客户请求的服务器。
- 后端存储（backend storage),它为服务器池提供一个共享的存储区，使服务器池拥有相同的内容，提供相同的服务。



二、IP负载均衡技术

在已有的IP负载技术中通过网络地址转换（Network Address Translation)将一组服务器构成一个高性能，高可用的的虚拟服务器，称为VS/NAT技术，在分析网络的非对称性基础上，提出了IP隧道实现虚拟服务器VS/TUN和VS/DR直接路由实现虚拟服务器。

通过VS/NAT实现虚拟服务器

NAT的工作原理是将报文头(目标地址，源地址和端口等)正确改写后，客户相信他们连接的一个IP地址，而不同的IP地址的服务器组也认为它们是与客户直接相连的。

![](https://raw.githubusercontent.com/zhouyinyan/zhouyinyan.github.io/master/images/LVS/LVS-NAT.jpg)

客户通过VIP(Virtual IP)访问网络服务时，请求报文到达调度器，调度器根据调度算法从一组真实的服务器中选出一台服务器，将报文的目标地址(VIP)改写为选定服务的地址，报文的目标端口改写为选定服务器的端口，最后将修改后的报文发送给服务器。同时，调度器在连接hash表中记录这个连接，当这个连接的下一个报文到达时，从连接hash表中可以得到原选定服务器的地址和端口，进行同样的改写，并将报文传给选定的服务器。当真实服务器的响应报文到达调度器后，调度器将报文的源地址和源端口改写为VIP和相应端口，在把报文发送给客户。这样客户看到的只是VIP上提供的服务，而后端的真实服务集群对客户透明。


通过VS/TUN实现虚拟服务器

在VS/NAT的集群系统中，请求和响应的数据报文都需要通过负载调度器，当真实服务器的数目在10台和20台之间时，负载调度器将成为整个集群系 统的新瓶颈。大多数Internet服务都有这样的特点：请求报文较短而响应报文往往包含大量的数据。如果能将请求和响应分开处理，即在负载调度器中只负责调度请求而响应直接返回给客户，将极大地提高整个集群系统的吞吐量。

IP隧道（IP tunneling）是将一个IP报文封装在另一个IP报文的技术，这可以使得目标为一个IP地址的数据报文能被封装和转发到另一个IP地址。IP隧道技术亦称为IP封装技术（IP encapsulation）。IP隧道主要用于移动主机和虚拟私有网络（Virtual Private Network），在其中隧道都是静态建立的，隧道一端有一个IP地址，另一端也有唯一的IP地址。

我们利用IP隧道技术将请求报文封装转发给后端服务器，响应报文能从后端服务器直接返回给客户。但在这里，后端服务器有一组而非一个，所以我们不可能静态地建立一一对应的隧道，而是动态地选择一台服务器，将请求报文封装和转发给选出的服务器。这样，我们可以利用IP隧道的原理将一组服务器上的网络服务组成在一个IP地址上的虚拟网络服务。

![](https://raw.githubusercontent.com/zhouyinyan/zhouyinyan.github.io/master/images/LVS/LVS-TUN.jpg)

它的连接调度和管理与VS/NAT中的一样，只是它的报文转发方法不同。调度器根据各个服务器的负载情况，动态地选择一台服务器，将请求报文封装在另一个IP报文中，再将封装后的IP报文转发给选出的服务器；服务器收到报文后，先将报文解封获得原来目标地址为VIP的报文，服务器发现VIP地址被配置在本地的IP隧道设备上，所以就处理这个请求，然后根据路由表将响应报文直接返回给客户。

![](https://raw.githubusercontent.com/zhouyinyan/zhouyinyan.github.io/master/images/LVS/LVS-TUN-principle.jpg)

在这里，请求报文的目标地址为VIP，响应报文的源地址也为VIP，所以响应报文不需要作任何修改，可以直接返回给客户，客户认为得到正常的服务，而不会知道是哪一台服务器处理的。

通过VS/DR实现虚拟服务器

跟VS/TUN方法相同，VS/DR利用大多数Internet服务的非对称特点，负载调度器中只负责调度请求，而服务器直接将响应返回给客户，可以极大地提高整个集群系统的吞吐量

![](https://raw.githubusercontent.com/zhouyinyan/zhouyinyan.github.io/master/images/LVS/LVS-DR.jpg)

调度器和服务器组都必须在物理上有一个网卡通过不分段的局域网相连，即通过交换机或者高速的HUB相连，中间 没有隔有路由器。VIP地址为调度器和服务器组共享，调度器配置的VIP地址是对外可见的，用于接收虚拟服务的请求报文；所有的服务器把VIP地址配置在 各自的Non-ARP网络设备上，它对外面是不可见的，只是用于处理目标地址为VIP的网络请求。

![](https://raw.githubusercontent.com/zhouyinyan/zhouyinyan.github.io/master/images/LVS/LVS-DR-principle.jpg)

它的连接调度和管理与VS/NAT和VS/TUN中的一样，它的报文转发方法又有不同，将报文直接路由给目标服务器。在VS/DR中，调度器根据各个服务器的负载情况，动态地选择一台服务器，不修改也不封装IP报文，而是将数据帧的MAC地址改为选出服务器的MAC地址，再将修改后的数据帧在与服务器组的局域网上发送。因为数据帧的MAC地址是选出的服务器，所以服务器肯定可以收到这个数据帧，从中可以获得该IP报文。当服务器发现报文的目标地址VIP是在本地的网络设备上，服务器处理这个报文，然后根据路由表将响应报文直接返回给客户。

在VS/DR中，请求报文的目标地址为VIP，响应报文的源地址也为VIP，所以响应报文不需要作任何修改，可以直接返回给客户，客户认为得到正常的服务，而不会知道是哪一台服务器处理的

三种方法的优缺点比较

VS/NAT的优点是服务器可以运行任何支持TCP/IP的操作系统，它只需要一个IP地址配置在调度器上，服务器组可以用私有的IP地址。缺点是它的伸缩能力有限，当服务器结点数目升到20时，调度器本身有可能成为系统的新瓶颈，因为在VS/NAT中请求和响应报文都需要通过负载调度器。对于那些将IP地址或者端口号在报文数据中传送的网络服务，需要编写相应的应用模块来转换报文数据中的IP地址或者端口号。这会带来实现的工作量，同时应用模块检查报文的开销会降低系统的吞吐率。


在VS/TUN 的集群系统中，负载调度器只将请求调度到不同的后端服务器，后端服务器将应答的数据直接返回给用户。这样，负载调度器就可以处理大量的请求，它甚至可以调度百台以上的服务器（同等规模的服务器），而它不会成为系统的瓶颈VS/TUN技术对服务器有要求，即所有的服务器必须支持“IP Tunneling”或者“IP Encapsulation”协议。

VS/DR调度器只处理客户到服务器端的连接，响应数据可以直接从独立的网络路由返回给客户。这可以极大地提高LVS集群系统的伸缩性。
跟VS/TUN相比，这种方法没有IP隧道的开销，但是要求负载调度器与实际服务器都有一块网卡连在同一物理网段上，服务器网络设备（或者设备别名）不作ARP响应，或者能将报文重定向（Redirect）到本地的Socket端口上。



